@page
@model NBADATA.Pages.CompareModel
@{
    ViewData["Title"] = "Comparar Jugadores";
}

<h1>Comparar jugadores</h1>

<form method="get">
    <div class="row">
        <div class="col-md-6 position-relative">
            <label for="player1Input" class="form-label">Jugador 1</label>
            <input asp-for="Player1"
                   class="form-control"
                   id="player1Input"
                   autocomplete="off" />
            <div id="player1Suggestions" class="suggestions-list"></div>
        </div>

        <div class="col-md-6 position-relative">
            <label for="player2Input" class="form-label">Jugador 2</label>
            <input asp-for="Player2"
                   class="form-control"
                   id="player2Input"
                   autocomplete="off" />
            <div id="player2Suggestions" class="suggestions-list"></div>
        </div>
    </div>

    <button type="submit" class="btn btn-primary mt-3">Comparar</button>
</form>

    @if (Model.Result1 != null && Model.Result2 != null)
    {
        @* Encabezado con fotos de los jugadores *@
        <div class="row mb-4">
            <div class="col-md-6 text-center">
                <div class="player-info">
                    @if (!string.IsNullOrWhiteSpace(Model.PhotoUrl1))
                    {
                        <img src="@Model.PhotoUrl1" alt="@Model.Result1.FullName" class="comparison-photo" onerror="this.style.display='none'" />
                    }
                    <h4 class="player-name">@Model.Result1.FullName</h4>
                    <p class="player-details">@Model.Result1.Team • @Model.Result1.Position</p>
                </div>
            </div>
            <div class="col-md-6 text-center">
                <div class="player-info">
                    @if (!string.IsNullOrWhiteSpace(Model.PhotoUrl2))
                    {
                        <img src="@Model.PhotoUrl2" alt="@Model.Result2.FullName" class="comparison-photo" onerror="this.style.display='none'" />
                    }
                    <h4 class="player-name">@Model.Result2.FullName</h4>
                    <p class="player-details">@Model.Result2.Team • @Model.Result2.Position</p>
                </div>
            </div>
        </div>

        @* Tabla comparativa de estadísticas *@
        <div class="stats-comparison">
            <h4 class="text-center mb-3">Comparación de Estadísticas</h4>
            <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 25%;">Estadística</th>
                                <th style="width: 37.5%;" class="text-center">
                                    @Model.Result1.FullName
                                    <br><small class="text-muted">@Model.Result1.Team</small>
                                </th>
                                <th style="width: 37.5%;" class="text-center">
                                    @Model.Result2.FullName
                                    <br><small class="text-muted">@Model.Result2.Team</small>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var prop in Model.Props)
                            {
                                var val1 = prop.GetValue(Model.Result1);
                                var val2 = prop.GetValue(Model.Result2);
                                
                                string text1 = val1 switch
                                {
                                    null => "-",
                                    DateTime dt => dt.ToShortDateString(),
                                    decimal d => d.ToString("0.##"),
                                    double d2 => d2.ToString("0.##"),
                                    float f => f.ToString("0.##"),
                                    _ => val1?.ToString() ?? "-"
                                };
                                
                                string text2 = val2 switch
                                {
                                    null => "-",
                                    DateTime dt => dt.ToShortDateString(),
                                    decimal d => d.ToString("0.##"),
                                    double d2 => d2.ToString("0.##"),
                                    float f => f.ToString("0.##"),
                                    _ => val2?.ToString() ?? "-"
                                };

                                // Determinar qué valor es mejor para estadísticas numéricas
                                string class1 = "";
                                string class2 = "";
                                if (IsNumericStat(prop.Name) && val1 != null && val2 != null)
                                {
                                    if (IsHigherBetter(prop.Name))
                                    {
                                        if (Convert.ToDouble(val1) > Convert.ToDouble(val2))
                                        {
                                            class1 = "table-success";
                                        }
                                        else if (Convert.ToDouble(val2) > Convert.ToDouble(val1))
                                        {
                                            class2 = "table-success";
                                        }
                                    }
                                    else
                                    {
                                        if (Convert.ToDouble(val1) < Convert.ToDouble(val2))
                                        {
                                            class1 = "table-success";
                                        }
                                        else if (Convert.ToDouble(val2) < Convert.ToDouble(val1))
                                        {
                                            class2 = "table-success";
                                        }
                                    }
                                }

                                <tr>
                                    <th class="bg-light">@GetDisplayName(prop.Name)</th>
                                    <td class="@class1 text-center fw-bold">@text1</td>
                                    <td class="@class2 text-center fw-bold">@text2</td>
                                </tr>
                            }
                        </tbody>
                    </table>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-md-6">
                @if (Model.Result1 == null && !string.IsNullOrWhiteSpace(Model.Player1))
                {
                    <div class="alert alert-warning text-center">
                        <h5>Jugador 1 no encontrado</h5>
                        <p>No se encontró ningún jugador que coincida con "@Model.Player1"</p>
                    </div>
                }
            </div>
            <div class="col-md-6">
                @if (Model.Result2 == null && !string.IsNullOrWhiteSpace(Model.Player2))
                {
                    <div class="alert alert-warning text-center">
                        <h5>Jugador 2 no encontrado</h5>
                        <p>No se encontró ningún jugador que coincida con "@Model.Player2"</p>
                    </div>
                }
            </div>
        </div>
    }

@functions {
    private bool IsNumericStat(string propName)
    {
        var numericStats = new[] { "Pts", "Reb", "Ast", "Stl", "Blk", "Tov", "FgPct", "TpPct", "FtPct" };
        return numericStats.Contains(propName);
    }

    private bool IsHigherBetter(string propName)
    {
        var lowerBetterStats = new[] { "Tov" };
        return !lowerBetterStats.Contains(propName);
    }

    private string GetDisplayName(string propName)
    {
        return propName switch
        {
            "FullName" => "Nombre Completo",
            "Team" => "Equipo",
            "Position" => "Posición",
            "HeightCm" => "Altura (cm)",
            "WeightKg" => "Peso (kg)",
            "BirthDate" => "Fecha de Nacimiento",
            "Pts" => "Puntos por Partido",
            "Reb" => "Rebotes por Partido",
            "Ast" => "Asistencias por Partido",
            "Stl" => "Robos por Partido",
            "Blk" => "Bloqueos por Partido",
            "Tov" => "Pérdidas por Partido",
            "FgPct" => "Porcentaje de Tiro de Campo",
            "TpPct" => "Porcentaje de Triple",
            "FtPct" => "Porcentaje de Tiro Libre",
            _ => propName
        };
    }
}

<style>
    .suggestions-list {
        position: absolute;
        z-index: 1000;
        width: 100%;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 0 0 4px 4px;
        max-height: 220px;
        overflow-y: auto;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: none;
    }

    .suggestion-item {
        padding: 6px 10px;
        cursor: pointer;
        font-size: 0.95rem;
    }

        .suggestion-item:hover {
            background: #f2f2f2;
        }
</style>


@section Scripts {
    <script>
        function setupAutocomplete(inputId, suggId) {
            const input = document.getElementById(inputId);
            const box = document.getElementById(suggId);
            let timer = null;

            if (!input || !box) return;

            input.addEventListener('input', () => {
                const q = input.value.trim();
                clearTimeout(timer);

                if (q.length < 2) {
                    box.innerHTML = '';
                    box.style.display = 'none';
                    return;
                }

                timer = setTimeout(async () => {
                    try {
                        const resp = await fetch(`/api/players/search?query=${encodeURIComponent(q)}`);
                        if (!resp.ok) return;
                        const data = await resp.json();

                        if (!Array.isArray(data) || data.length === 0) {
                            box.innerHTML = '';
                            box.style.display = 'none';
                            return;
                        }

                        box.innerHTML = '';
                        data.forEach(p => {
                            const item = document.createElement('div');
                            item.className = 'suggestion-item';
                            item.textContent = `${p.fullName} (${p.team})`;
                            item.addEventListener('click', () => {
                                input.value = p.fullName; // rellena el input
                                box.innerHTML = '';
                                box.style.display = 'none';
                            });
                            box.appendChild(item);
                        });

                        box.style.display = 'block';
                    } catch (e) {
                        console.error(e);
                    }
                }, 200);
            });

            // Cerrar cuando haces click fuera
            document.addEventListener('click', (e) => {
                if (!box.contains(e.target) && e.target !== input) {
                    box.innerHTML = '';
                    box.style.display = 'none';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupAutocomplete('player1Input', 'player1Suggestions');
            setupAutocomplete('player2Input', 'player2Suggestions');
        });
    </script>
}
