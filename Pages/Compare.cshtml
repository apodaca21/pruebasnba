@page
@model NBADATA.Pages.CompareModel
@{
    ViewData["Title"] = "Comparar Jugadores";
}

@section Styles {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="~/css/player.css" asp-append-version="true" />
}

<div class="compare-page">
    <div class="page-header mb-4">
        <h1 class="page-title">
            <i class="fas fa-balance-scale"></i> Comparar Jugadores
        </h1>
        <p class="page-subtitle">Analiza y compara estadísticas de jugadores de la NBA</p>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">
                <i class="fas fa-search"></i> Buscar Jugadores
            </h5>
        </div>
        <div class="card-body">
            <form method="get" id="compareForm">
                <div class="row g-3">
                    <div class="col-md-5 position-relative">
                        <label for="player1Input" class="form-label fw-bold">
                            <i class="fas fa-user"></i> Jugador 1
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-basketball-ball"></i>
                            </span>
                            <input asp-for="Player1"
                                   class="form-control"
                                   id="player1Input"
                                   placeholder="Ej: LeBron James"
                                   autocomplete="off" />
                        </div>
                        <div id="player1Suggestions" class="suggestions-list"></div>
                    </div>

                    <div class="col-md-5 position-relative">
                        <label for="player2Input" class="form-label fw-bold">
                            <i class="fas fa-user"></i> Jugador 2
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-basketball-ball"></i>
                            </span>
                            <input asp-for="Player2"
                                   class="form-control"
                                   id="player2Input"
                                   placeholder="Ej: Stephen Curry"
                                   autocomplete="off" />
                        </div>
                        <div id="player2Suggestions" class="suggestions-list"></div>
                    </div>

                    <div class="col-md-2">
                        <label for="seasonSelect" class="form-label fw-bold">
                            <i class="fas fa-calendar"></i> Temporada
                        </label>
                        <select asp-for="Season" class="form-select" id="seasonSelect">
                            @foreach (var season in Model.AvailableSeasons)
                            {
                                <option value="@season">@season</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-primary btn-lg w-100" id="compareBtn">
                        <i class="fas fa-balance-scale"></i> Comparar Jugadores
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Indicador de carga -->
    <div id="loadingIndicator" class="text-center py-5" style="display: none;">
        <div class="loading-spinner mx-auto mb-3" style="width: 50px; height: 50px; border-width: 4px;"></div>
        <p class="text-muted">Cargando datos de los jugadores...</p>
    </div>

    @if (Model.Result1 != null && Model.Result2 != null)
    {
        @* Encabezado con fotos de los jugadores y selector de temporada *@
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-12 text-center">
                        <h5 class="mb-2">
                            <i class="fas fa-calendar-alt"></i> Temporada: <strong>@Model.Season</strong>
                        </h5>
                        <form method="get" class="d-inline">
                            <input type="hidden" name="player1" value="@Model.Player1" />
                            <input type="hidden" name="player2" value="@Model.Player2" />
                            <div class="input-group" style="max-width: 300px; margin: 0 auto;">
                                <label class="input-group-text" for="seasonChangeSelect">
                                    <i class="fas fa-calendar"></i>
                                </label>
                                <select name="season" class="form-select" id="seasonChangeSelect" onchange="this.form.submit()">
                                    @foreach (var season in Model.AvailableSeasons)
                                    {
                                        <option value="@season" selected="@(season == Model.Season)">@season</option>
                                    }
                                </select>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 text-center">
                        <div class="player-info">
                            @if (!string.IsNullOrWhiteSpace(Model.PhotoUrl1))
                            {
                                <img src="@Model.PhotoUrl1" alt="@Model.Result1.FullName" class="comparison-photo mb-3" onerror="this.style.display='none'" />
                            }
                            else
                            {
                                <div class="comparison-photo mb-3 d-flex align-items-center justify-content-center bg-light">
                                    <i class="fas fa-user fa-5x text-muted"></i>
                                </div>
                            }
                            <h4 class="player-name">@Model.Result1.FullName</h4>
                            <p class="player-details">
                                <span class="badge bg-secondary">@Model.Result1.Team</span>
                                <span class="badge bg-info">@Model.Result1.Position</span>
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6 text-center">
                        <div class="player-info">
                            @if (!string.IsNullOrWhiteSpace(Model.PhotoUrl2))
                            {
                                <img src="@Model.PhotoUrl2" alt="@Model.Result2.FullName" class="comparison-photo mb-3" onerror="this.style.display='none'" />
                            }
                            else
                            {
                                <div class="comparison-photo mb-3 d-flex align-items-center justify-content-center bg-light">
                                    <i class="fas fa-user fa-5x text-muted"></i>
                                </div>
                            }
                            <h4 class="player-name">@Model.Result2.FullName</h4>
                            <p class="player-details">
                                <span class="badge bg-secondary">@Model.Result2.Team</span>
                                <span class="badge bg-info">@Model.Result2.Position</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* Tabla comparativa de estadísticas *@
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
                <h4 class="mb-0 text-center">
                    <i class="fas fa-chart-bar"></i> Comparación de Estadísticas
                </h4>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 25%;">Estadística</th>
                                <th style="width: 37.5%;" class="text-center">
                                    @Model.Result1.FullName
                                    <br><small class="text-muted">@Model.Result1.Team</small>
                                </th>
                                <th style="width: 37.5%;" class="text-center">
                                    @Model.Result2.FullName
                                    <br><small class="text-muted">@Model.Result2.Team</small>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var prop in Model.Props)
                            {
                                var val1 = prop.GetValue(Model.Result1);
                                var val2 = prop.GetValue(Model.Result2);
                                
                                // Formatear valores (excluir BirthDate que ya no se muestra)
                                string text1 = val1 switch
                                {
                                    null => "-",
                                    decimal d => d.ToString("0.##"),
                                    double d2 => d2.ToString("0.##"),
                                    float f => f.ToString("0.##"),
                                    int i when prop.Name == "HeightCm" || prop.Name == "WeightKg" => i > 0 ? i.ToString() : "-",
                                    _ => val1?.ToString() ?? "-"
                                };
                                
                                string text2 = val2 switch
                                {
                                    null => "-",
                                    decimal d => d.ToString("0.##"),
                                    double d2 => d2.ToString("0.##"),
                                    float f => f.ToString("0.##"),
                                    int i when prop.Name == "HeightCm" || prop.Name == "WeightKg" => i > 0 ? i.ToString() : "-",
                                    _ => val2?.ToString() ?? "-"
                                };

                                // Determinar qué valor es mejor para estadísticas numéricas
                                // Solo comparar estadísticas relevantes (no altura, peso, etc.)
                                string class1 = "";
                                string class2 = "";
                                if (IsNumericStat(prop.Name) && val1 != null && val2 != null && 
                                    (prop.Name == "Pts" || prop.Name == "Reb" || prop.Name == "Ast" || 
                                     prop.Name == "Stl" || prop.Name == "Blk" || prop.Name == "Tov" ||
                                     prop.Name == "FgPct" || prop.Name == "TpPct" || prop.Name == "FtPct"))
                                {
                                    if (IsHigherBetter(prop.Name))
                                    {
                                        if (Convert.ToDouble(val1) > Convert.ToDouble(val2))
                                        {
                                            class1 = "table-success";
                                        }
                                        else if (Convert.ToDouble(val2) > Convert.ToDouble(val1))
                                        {
                                            class2 = "table-success";
                                        }
                                    }
                                    else
                                    {
                                        if (Convert.ToDouble(val1) < Convert.ToDouble(val2))
                                        {
                                            class1 = "table-success";
                                        }
                                        else if (Convert.ToDouble(val2) < Convert.ToDouble(val1))
                                        {
                                            class2 = "table-success";
                                        }
                                    }
                                }

                                <tr>
                                    <th class="bg-light">@GetDisplayName(prop.Name)</th>
                                    <td class="@class1 text-center fw-bold">@text1</td>
                                    <td class="@class2 text-center fw-bold">@text2</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else if (!string.IsNullOrWhiteSpace(Model.Player1) || !string.IsNullOrWhiteSpace(Model.Player2))
    {
        <div class="row">
            <div class="col-md-6">
                @if (Model.Result1 == null && !string.IsNullOrWhiteSpace(Model.Player1))
                {
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h5 class="alert-heading">Jugador 1 no encontrado</h5>
                        <p class="mb-0">No se encontró ningún jugador que coincida con "<strong>@Model.Player1</strong>"</p>
                        <hr>
                        <p class="mb-0 small">Intenta buscar por apellido o verifica la ortografía del nombre.</p>
                    </div>
                }
            </div>
            <div class="col-md-6">
                @if (Model.Result2 == null && !string.IsNullOrWhiteSpace(Model.Player2))
                {
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h5 class="alert-heading">Jugador 2 no encontrado</h5>
                        <p class="mb-0">No se encontró ningún jugador que coincida con "<strong>@Model.Player2</strong>"</p>
                        <hr>
                        <p class="mb-0 small">Intenta buscar por apellido o verifica la ortografía del nombre.</p>
                    </div>
                }
            </div>
        </div>
    }
</div>

@functions {
    private bool IsNumericStat(string propName)
    {
        var numericStats = new[] { "Pts", "Reb", "Ast", "Stl", "Blk", "Tov", "FgPct", "TpPct", "FtPct" };
        return numericStats.Contains(propName);
    }

    private bool IsHigherBetter(string propName)
    {
        var lowerBetterStats = new[] { "Tov" };
        return !lowerBetterStats.Contains(propName);
    }

    private string GetDisplayName(string propName)
    {
        return propName switch
        {
            "FullName" => "Nombre Completo",
            "Team" => "Equipo",
            "Position" => "Posición",
            "HeightCm" => "Altura (cm)",
            "WeightKg" => "Peso (kg)",
            "Pts" => "Puntos por Partido",
            "Reb" => "Rebotes por Partido",
            "Ast" => "Asistencias por Partido",
            "Stl" => "Robos por Partido",
            "Blk" => "Bloqueos por Partido",
            "Tov" => "Pérdidas por Partido",
            "FgPct" => "Porcentaje de Tiro de Campo",
            "TpPct" => "Porcentaje de Triple",
            "FtPct" => "Porcentaje de Tiro Libre",
            _ => propName
        };
    }
}

<style>
    .suggestions-list {
        position: absolute;
        z-index: 1000;
        width: 100%;
        background: #fff;
        border: 1px solid #d1d5db;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 250px;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: none;
        margin-top: -1px;
    }

    .suggestion-item {
        padding: 12px 16px;
        cursor: pointer;
        font-size: 0.95rem;
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.2s ease;
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .suggestion-item:hover {
        background: #f9fafb;
    }

    .suggestion-item:active {
        background: #f3f4f6;
    }

    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        font-size: 1.1rem;
        color: var(--text-muted);
        margin-bottom: 0;
    }

    @@media (max-width: 768px) {
        .page-title {
            font-size: 2rem;
        }
        
        .page-subtitle {
            font-size: 1rem;
        }
    }
</style>


@section Scripts {
    <script>
        function setupAutocomplete(inputId, suggId) {
            const input = document.getElementById(inputId);
            const box = document.getElementById(suggId);
            let timer = null;

            if (!input || !box) return;

            input.addEventListener('input', () => {
                const q = input.value.trim();
                clearTimeout(timer);

                if (q.length < 2) {
                    box.innerHTML = '';
                    box.style.display = 'none';
                    return;
                }

                timer = setTimeout(async () => {
                    try {
                        const resp = await fetch(`/api/nba/search?query=${encodeURIComponent(q)}`);
                        if (!resp.ok) {
                            box.innerHTML = '<div class="suggestion-item text-muted">Error al buscar jugadores</div>';
                            box.style.display = 'block';
                            return;
                        }
                        const data = await resp.json();

                        if (!Array.isArray(data) || data.length === 0) {
                            box.innerHTML = '<div class="suggestion-item text-muted">No se encontraron jugadores</div>';
                            box.style.display = 'block';
                            return;
                        }

                        box.innerHTML = '';
                        data.slice(0, 10).forEach(p => { // Limitar a 10 resultados
                            const item = document.createElement('div');
                            item.className = 'suggestion-item';
                            item.innerHTML = `
                                <div class="fw-bold">${escapeHtml(p.fullName)}</div>
                                <small class="text-muted">${escapeHtml(p.team)} • ${escapeHtml(p.position)}</small>
                            `;
                            item.addEventListener('click', () => {
                                input.value = p.fullName;
                                box.innerHTML = '';
                                box.style.display = 'none';
                            });
                            box.appendChild(item);
                        });

                        box.style.display = 'block';
                    } catch (e) {
                        console.error('Error en autocompletado:', e);
                        box.innerHTML = '<div class="suggestion-item text-danger">Error de conexión</div>';
                        box.style.display = 'block';
                    }
                }, 300);
            });

            // Cerrar cuando haces click fuera
            document.addEventListener('click', (e) => {
                if (!box.contains(e.target) && e.target !== input) {
                    box.innerHTML = '';
                    box.style.display = 'none';
                }
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupAutocomplete('player1Input', 'player1Suggestions');
            setupAutocomplete('player2Input', 'player2Suggestions');

            // Mostrar indicador de carga al enviar formulario
            const compareForm = document.getElementById('compareForm');
            if (compareForm) {
                compareForm.addEventListener('submit', function() {
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'block';
                    }
                    const compareBtn = document.getElementById('compareBtn');
                    if (compareBtn) {
                        compareBtn.disabled = true;
                        compareBtn.innerHTML = '<span class="loading-spinner me-2"></span>Cargando...';
                    }
                });
            }

            // Actualizar estadísticas cuando cambie la temporada
            const seasonSelect = document.getElementById('seasonSelect');
            if (seasonSelect) {
                seasonSelect.addEventListener('change', function() {
                    if (compareForm) {
                        compareForm.submit();
                    }
                });
            }
        });
    </script>
}
